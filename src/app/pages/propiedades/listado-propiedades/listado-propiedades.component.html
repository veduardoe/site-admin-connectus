
<app-return [url]="'/agentes'" [text]="'VOLVER AL LISTADO DE AGENTES'" *ngIf="agente?.tipoUsuario === 'AGENTE'"></app-return>
<app-return [url]="'/administradores'" [text]="'VOLVER AL LISTADO DE ADMINISTRADORES'" *ngIf="agente?.tipoUsuario === 'ADMIN'"></app-return>

<mat-card class="info-ag" *ngIf="agente">
    <div fxLayout="row">
        <div fxFlex>
            <img *ngIf="!agente.foto" [src]="routeFotoPerfil + 'blank_profile.png?alt=media'" class="pic-det">
            <img *ngIf="agente.foto" [src]="routeFotoPerfil + agente.foto + '?alt=media'" class="pic-det">
        </div>
        <div fxFlex="100%">
            <div class="sedet"><b>{{ agente.tipoUsuario === 'ADMIN' ? 'Administrador' : 'Agente'}}:</b> {{ agente.nombres }} {{ agente.apellido_paterno }} {{ agente.apellido_materno }} </div>
            <div class="sedet"><b>RUT:</b> {{ agente.rut }}</div>
            <div class="sedet"><b>Estado:</b> {{ agente.estado | removeUnderscore }} </div>
        </div>

    </div>
    
</mat-card>
<div class="appSection">
    <div class="white-container mat-elevation-z2">
        <div class="search-input">
            <div fxLayout="row wrap" fxLayoutAlign="space-between center">
                <div fxFlex fxFlex.xs="100%" class="alignLeft" *ngIf="!agente">
                    <button mat-flat-button color="primary" class="btnCustom boldy"
                        [routerLink]="'/propiedades/detalle'">Nueva Propiedad</button>
                </div>
                <div fxFlex fxFlex.xs="100%" class="alignRight">
                    <button mat-flat-button color="primary" class="btnCustom boldy btnExcel" (click)="exportarExcel()">
                        <i class="fal fa-file-excel"></i>                        EXPORTAR EXCEL</button>
                    <mat-form-field appearance="outline" class="no-padding">
                        <mat-label>Buscar</mat-label>
                        <input matInput placeholder="Escriba..." (keyup)="setFilter($event.target.value)">
                        <mat-icon matSuffix>search</mat-icon>
                    </mat-form-field>
                </div>
            </div>
        </div>
        <div class="content-scrollable">
            <div class="table-scrollable">
                <table mat-table [dataSource]="dataSource" class="responsiveActive" matSort>

                    <ng-container matColumnDef="foto" sticky>
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Foto </th>
                        <td mat-cell *matCellDef="let e" data-label="Foto" class="main-pic-table">
                            <img class="pics-table" [src]="picRoutePropiedades + e.fotos[0].fichero + '?alt=media'"
                                *ngIf="e.fotos && e.fotos.length > 0" />
                            <img class="pics-table" [src]="picRoutePropiedades + 'not-found.jpg?alt=media'"
                                *ngIf="!e.fotos || e.fotos.length === 0" />
                            <mat-icon class="ribbon" *ngIf="e.destacado" matTooltip="Propiedad Destacada">verified</mat-icon>

                        </td>
                    </ng-container>

                    <ng-container matColumnDef="titulo">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 170px;"> Título </th>
                        <td mat-cell *matCellDef="let e" data-label="titulo">
                            <span class="overflow-text">{{e.titulo}}</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="agente">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 170px;"> Agente </th>
                        <td mat-cell *matCellDef="let e" data-label="Agente">
                            <span class="overflow-text"><b>{{e.agenteAsignado}}</b></span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="codigoReferencia">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Referencia </th>
                        <td mat-cell *matCellDef="let e" data-label="Referencia"> <span>{{e.codigoReferencia}}</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="tipoOperacion">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo de Operación </th>
                        <td mat-cell *matCellDef="let e" data-label="Tipo de Operación">
                            <span>{{e.tipoOperacion}}</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="region">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 170px;"> Región </th>
                        <td mat-cell *matCellDef="let e" data-label="Región">
                            <span>{{e.region}}</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="comuna">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 170px;"> Comuna </th>
                        <td mat-cell *matCellDef="let e" data-label="Comuna">
                            <span>{{e.comuna}}</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="precio">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 170px;"> Precio </th>
                        <td mat-cell *matCellDef="let e" data-label="Precio">
                            <span class="text-some-large">
                                {{e.moneda}} {{e.precio  | number : '1.0-0'}} <br />
                                <span class="altpr">CLP {{ (e.precio * indicadores?.uf?.valor | number : '1.0-0') }}</span>
                                <span class="altpr">USD {{ ((e.precio * indicadores?.uf?.valor) / indicadores?.dolar_intercambio?.valor | number: '1.0-0') }}</span>

                            </span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="habitaciones" >
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 20px;"> Habit.</th>
                        <td mat-cell *matCellDef="let e" data-label="Habitaciones"> <span>{{e.habitaciones === -1 ? 'N/A' : e.habitaciones}}</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="banos">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 20px;"> Baños</th>
                        <td mat-cell *matCellDef="let e" data-label="Baños"> <span>{{e.banos === -1 ? 'N/A' : e.banos }}</span> </td>
                    </ng-container>

                    <ng-container matColumnDef="metraje">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 20px;"> Dimens.</th>
                        <td mat-cell *matCellDef="let e" data-label="Dimens"> <span>{{e.metraje}}m<sup>2</sup></span> </td>
                    </ng-container>

                    <ng-container matColumnDef="estacionamiento">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 20px;"> Estacio.</th>
                        <td mat-cell *matCellDef="let e" data-label="Estacio"> <span>{{e.estacionamiento === -1 ? 'N/A' : e.estacionamiento }}</span> </td>
                    </ng-container>

                    <ng-container matColumnDef="fechaRegistro">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 170px;"> Fecha y Hora Registro</th>
                        <td mat-cell *matCellDef="let e" data-label="Baños"> <span>{{e.fechaRegistro | date:'dd-MM-yyyy
                                HH:mm:ss'}}</span> </td>
                    </ng-container>

                    <ng-container matColumnDef="fechaModificacion">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 170px;"> Última Modificación</th>
                        <td mat-cell *matCellDef="let e" data-label="Última Modificación">
                            <span>{{e.fechaModificacion | date:'dd-MM-yyyy
                                HH:mm:ss'}}</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="estado">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header style="min-width: 100px;"> Estado </th>
                        <td mat-cell *matCellDef="let e" data-label="Estado"  
                        [ngClass]="{ 'success' : e.estado === 'ACTIVO', 
                                     'danger' : e.estado === 'INACTIVO',
                                     'gray' : e.estado === 'NO DISPONIBLE',
                                     'purple' : e.estado === 'VENDIDA' }">
                            <span class="cell-estado" >
                                {{e.estado | removeUnderscore}}
                            </span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="acciones" stickyEnd>
                        <th mat-header-cell *matHeaderCellDef style="text-align: center;">.....                                
                        </th>
                        <td mat-cell *matCellDef="let e" data-label="Acciones" class="bg-gray">
                            <span>                            

                                <mat-menu #menu="matMenu">
                                    <button mat-menu-item [routerLink]="'detalle/' + e._id">
                                        <mat-icon>create</mat-icon>
                                        <span>Editar</span>
                                    </button>
                                </mat-menu>
                                <button mat-icon-button [matMenuTriggerFor]="menu" matTooltipPosition="right">
                                    <mat-icon>more_vert</mat-icon>
                                </button>
                            </span>

                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="columns" class="bgheader"></tr>
                    <tr mat-row *matRowDef="let row; columns: columns;"></tr>
                </table>
            </div>
            <p class="noresults" *ngIf="length === 0">No se encontraron resultados</p>
        </div>
        <mat-paginator [pageSize]="20" [pageSizeOptions]="[20,50,100]" (page)="utils.fnGoTop()"></mat-paginator>
    </div>
</div>